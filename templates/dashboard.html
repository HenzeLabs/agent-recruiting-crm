{% extends "base.html" %}
{% block content %}
<div class="dashboard-layout">
  
  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="nav-item active" onclick="showSection('overview')">
        <span class="nav-icon">üìä</span>
        <span class="nav-label">Dashboard</span>
      </div>
      <div class="nav-item" onclick="showSection('priority')">
        <span class="nav-icon">üî•</span>
        <span class="nav-label">Priority</span>
        {% if overdue_count > 0 %}<span class="badge">{{ overdue_count }}</span>{% endif %}
      </div>
      <div class="nav-item" onclick="showSection('pipeline')">
        <span class="nav-icon">üìà</span>
        <span class="nav-label">Pipeline</span>
      </div>
      <div class="nav-item" onclick="showSection('recruits')">
        <span class="nav-icon">üë•</span>
        <span class="nav-label">All Recruits</span>
      </div>
    </div>
    
    <div class="sidebar-section">
      <div class="nav-item" onclick="window.location.href='/add'">
        <span class="nav-icon">‚ûï</span>
        <span class="nav-label">Add Recruit</span>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    
    <!-- Overview Section -->
    <div class="content-section active" id="overview-section">
      <div class="section-header">
        <h2>Dashboard Overview</h2>
        <p>{{ recruits|length }} total recruits ‚Ä¢ {{ weekly_new }} added this week</p>
      </div>
      
      <div class="cards-grid">
        {% for stage, count in counts.items() %}
        <div class="metric-card" onclick="showStageDetails('{{ stage }}')">
          <div class="metric-number">{{ count }}</div>
          <div class="metric-label">{{ stage }}</div>
        </div>
        {% endfor %}
        
        <div class="metric-card urgent {% if overdue_count > 0 %}has-alerts{% endif %}">
          <div class="metric-number">{{ overdue_count }}</div>
          <div class="metric-label">Need Follow-up</div>
        </div>
      </div>
      
      {% if overdue_count > 0 %}
      <div class="alert-section">
        <h3>‚ö†Ô∏è Requires Attention ({{ overdue_count }})</h3>
        <div class="quick-list">
          {% for r in recruits[:3] %}
            {% if r.get('is_overdue') %}
            <div class="quick-item">
              <span class="name">{{ r['name'] }}</span>
              <span class="stage">{{ r['stage'] }}</span>
              <button class="btn-mini" onclick="quickFollowup({{ r['id'] }}, '{{ r['name'] }}', '{{ r['stage'] }}')">Follow-up</button>
            </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Priority Section -->
    <div class="content-section" id="priority-section">
      <div class="section-header">
        <h2>üî• Priority Actions</h2>
        <p>Recruits needing immediate attention</p>
      </div>
      
      <div class="recruits-grid">
        {% for r in recruits %}
          {% if r.get('is_overdue') or r['stage'] == 'New' %}
            {% include 'recruit_card.html' %}
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- Pipeline Section -->
    <div class="content-section" id="pipeline-section">
      <div class="section-header">
        <h2>üìà Pipeline Analysis</h2>
        <p>Track progress through recruitment stages</p>
      </div>
      
      <div class="pipeline-flow">
        {% for stage in stages %}
        <div class="pipeline-stage" onclick="filterByStage('{{ stage }}')">
          <div class="stage-count">{{ counts[stage] }}</div>
          <div class="stage-name">{{ stage }}</div>
          <div class="stage-bar">
            <div class="stage-fill" style="width: {{ (counts[stage] / recruits|length * 100) if recruits|length > 0 else 0 }}%"></div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <div class="conversion-stats">
        <div class="stat-item">
          <span class="stat-value">{{ weekly_licensed }}</span>
          <span class="stat-label">Licensed This Week</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ ((weekly_licensed / weekly_new * 100) if weekly_new > 0 else 0)|round(1) }}%</span>
          <span class="stat-label">Conversion Rate</span>
        </div>
      </div>
    </div>

    <!-- All Recruits Section -->
    <div class="content-section" id="recruits-section">
      <div class="section-header">
        <h2>üë• All Recruits</h2>
        <div class="filter-pills">
          <button class="filter-pill active" onclick="filterRecruits('all')">All</button>
          {% for stage in stages %}
            <button class="filter-pill" onclick="filterRecruits('{{ stage }}')">{{ stage }}</button>
          {% endfor %}
        </div>
      </div>
      
      <div class="recruits-grid" id="all-recruits">
        {% for r in recruits %}
          {% include 'recruit_card.html' %}
        {% endfor %}
      </div>
    </div>

  </main>
</div>
    
    <!-- Priority Actions -->
    {% if overdue_count > 0 or recruits|selectattr('stage', 'equalto', 'New')|list|length > 0 %}
    <div class="section-container priority-section">
      <button class="section-toggle active" onclick="toggleSection('priority')">
        <span class="toggle-icon">‚ñº</span>
        <h3>üî• Priority Actions ({{ (overdue_count + recruits|selectattr('stage', 'equalto', 'New')|list|length) }})</h3>
      </button>
      <div class="section-content" id="priority-content">
        {% for r in recruits %}
          {% if r.get('is_overdue') or r['stage'] == 'New' %}
            {% include 'recruit_card.html' %}
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Pipeline Overview -->
    <div class="section-container">
      <button class="section-toggle" onclick="toggleSection('pipeline')">
        <span class="toggle-icon">‚ñ∂</span>
        <h3>üìä Pipeline Overview</h3>
      </button>
      <div class="section-content collapsed" id="pipeline-content">
        <div class="stats-row">
          {% for stage, count in counts.items() %}
            <div class="stat-card" onclick="filterByStage('{{ stage }}')">
              <div class="stat-content">
                <h3>{{ count }}</h3>
                <p>{{ stage }}</p>
              </div>
            </div>
          {% endfor %}
        </div>
        <div class="weekly-details">
          <p><strong>{{ weekly_new }}</strong> new ‚Ä¢ <strong>{{ weekly_licensed }}</strong> licensed ‚Ä¢ <strong>{{ ((weekly_licensed / weekly_new * 100) if weekly_new > 0 else 0)|round(1) }}%</strong> conversion</p>
        </div>
      </div>
    </div>

    <!-- Active Recruits -->
    <div class="section-container">
      <button class="section-toggle" onclick="toggleSection('active')">
        <span class="toggle-icon">‚ñ∂</span>
        <h3>üë• Active Recruits ({{ recruits|selectattr('stage', 'in', ['Contacted', 'In Training'])|list|length }})</h3>
      </button>
      <div class="section-content collapsed" id="active-content">
        {% for r in recruits %}
          {% if r['stage'] in ['Contacted', 'In Training'] %}
            {% include 'recruit_card.html' %}
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- All Recruits -->
    <div class="section-container">
      <button class="section-toggle" onclick="toggleSection('all')">
        <span class="toggle-icon">‚ñ∂</span>
        <h3>üìã All Recruits ({{ recruits|length }})</h3>
      </button>
      <div class="section-content collapsed" id="all-content">
        <div class="filter-tabs">
          <button class="filter-tab active" onclick="filterRecruits('all')">All</button>
          {% for stage in stages %}
            <button class="filter-tab" onclick="filterRecruits('{{ stage }}')">{{ stage }}</button>
          {% endfor %}
        </div>
        <div class="recruits-list" id="all-recruits">
          {% for r in recruits %}
            {% include 'recruit_card.html' %}
          {% endfor %}
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Quick Follow-up Modal -->
<div id="followupModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Quick Follow-up</h3>
      <button class="modal-close" onclick="closeFollowupModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p>Send follow-up to <strong id="followupName"></strong></p>
      
      <div class="template-buttons" id="templateButtons">
        <!-- Templates will be loaded here -->
      </div>
      
      <div class="custom-message">
        <label for="customMessage">Or write custom message:</label>
        <textarea id="customMessage" rows="3" placeholder="Type your message..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" onclick="sendFollowup()">Send & Mark Contact</button>
      <button class="btn-secondary" onclick="closeFollowupModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
let currentRecruitId = null;
let messageTemplates = [];

// Load templates on page load
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const response = await fetch('/api/templates');
    messageTemplates = await response.json();
  } catch (error) {
    console.error('Failed to load templates:', error);
  }
});

// Section navigation
function showSection(sectionId) {
  // Hide all sections
  document.querySelectorAll('.content-section').forEach(section => {
    section.classList.remove('active');
  });
  
  // Remove active from nav items
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Show selected section
  document.getElementById(sectionId + '-section').classList.add('active');
  
  // Highlight nav item
  event.target.closest('.nav-item').classList.add('active');
}

function showStageDetails(stage) {
  showSection('recruits');
  setTimeout(() => filterRecruits(stage), 100);
}

// Filter recruits by stage
function filterRecruits(stage) {
  const cards = document.querySelectorAll('#all-recruits .recruit-card');
  const pills = document.querySelectorAll('.filter-pill');
  
  // Update active pill
  pills.forEach(pill => pill.classList.remove('active'));
  if (event && event.target) event.target.classList.add('active');
  
  // Show/hide cards
  cards.forEach(card => {
    if (stage === 'all' || card.dataset.stage === stage) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

// Filter by stage from pipeline
function filterByStage(stage) {
  // Open all recruits section
  const allSection = document.getElementById('all-content');
  if (allSection.classList.contains('collapsed')) {
    toggleSection('all');
  }
  
  // Filter to specific stage
  setTimeout(() => {
    const stageTab = document.querySelector(`[onclick="filterRecruits('${stage}')"]`);
    if (stageTab) stageTab.click();
  }, 100);
}

function quickFollowup(recruitId, name, stage) {
  currentRecruitId = recruitId;
  document.getElementById('followupName').textContent = name;
  
  // Show relevant templates
  const templateButtons = document.getElementById('templateButtons');
  templateButtons.innerHTML = '';
  
  const relevantTemplates = messageTemplates.filter(t => 
    t.stage === stage || t.stage === null
  );
  
  relevantTemplates.forEach(template => {
    const btn = document.createElement('button');
    btn.className = 'template-btn';
    btn.textContent = template.name;
    btn.onclick = () => selectTemplate(template.id, template.content.replace('{name}', name));
    templateButtons.appendChild(btn);
  });
  
  document.getElementById('followupModal').style.display = 'flex';
}

function selectTemplate(templateId, content) {
  document.getElementById('customMessage').value = content;
  // Highlight selected template
  document.querySelectorAll('.template-btn').forEach(btn => btn.classList.remove('selected'));
  event.target.classList.add('selected');
}

async function sendFollowup() {
  const message = document.getElementById('customMessage').value.trim();
  if (!message) {
    alert('Please enter a message');
    return;
  }
  
  try {
    const response = await fetch('/api/quick-message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        recruit_id: currentRecruitId,
        message: message
      })
    });
    
    if (response.ok) {
      window.crm.showNotification('Follow-up sent!', 'success');
      closeFollowupModal();
      
      // Remove overdue badge
      const card = document.querySelector(`[data-recruit-id="${currentRecruitId}"]`);
      if (card) {
        card.classList.remove('overdue');
        const badge = card.querySelector('.overdue-badge');
        if (badge) badge.remove();
      }
      
      // Update stats
      window.crm.refreshStats();
    } else {
      throw new Error('Failed to send');
    }
  } catch (error) {
    window.crm.showNotification('Failed to send follow-up', 'error');
  }
}

function closeFollowupModal() {
  document.getElementById('followupModal').style.display = 'none';
  document.getElementById('customMessage').value = '';
  currentRecruitId = null;
}
</script>

{% endblock %}
